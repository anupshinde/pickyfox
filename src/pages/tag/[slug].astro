---
import { getCollection } from 'astro:content';
import { SITE } from '../../consts';
import { TAG_DEFINITIONS, type TagSlug } from '../../config/tagTaxonomy';
import BaseLayout from '../../layouts/BaseLayout.astro';

type TagPageProps = {
  tagSlug: TagSlug;
  tagTitle: string;
};

export async function getStaticPaths() {
  return TAG_DEFINITIONS.map((tag) => ({
    params: { slug: tag.slug },
    props: {
      tagSlug: tag.slug,
      tagTitle: tag.title
    }
  }));
}

const { tagSlug, tagTitle } = Astro.props as TagPageProps;
const posts = (await getCollection('posts'))
  .filter((post) => post.data.tags?.includes(tagSlug))
  .sort((a, b) => new Date(b.data.date || 0).getTime() - new Date(a.data.date || 0).getTime());
---
<BaseLayout
  title={`${tagTitle}`}
  description={`Browse ${tagTitle} posts on ${SITE.name}.`}
>
  <section class="py-10">
    <p class="text-sm font-semibold uppercase tracking-[0.08em] text-brand-500">Tag</p>
    <h1 class="mt-2 text-3xl font-extrabold tracking-tight text-slate-900 sm:text-4xl">{tagTitle}</h1>
  </section>

  {posts.length > 0 ? (
    <section class="grid gap-6 pb-14 sm:grid-cols-2 lg:grid-cols-3">
      {posts.map((post) => (
        <article class="overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm transition hover:-translate-y-1 hover:shadow-lg">
          {post.data.featureImage && (
            <img
              class="h-48 w-full object-cover"
              src={post.data.featureImage}
              alt={post.data.featureImageAlt || post.data.title}
            />
          )}
          <div class="space-y-3 p-5">
            <h2 class="text-lg font-semibold text-slate-900">
              <a class="transition hover:text-slate-700" href={`/${post.slug}/`}>{post.data.title}</a>
            </h2>
            <p class="text-xs uppercase tracking-[0.2em] text-slate-500">
              {new Date(post.data.date || '').toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
              })}
            </p>
            {post.data.excerpt && <p class="text-sm leading-relaxed text-slate-600">{post.data.excerpt}</p>}
          </div>
        </article>
      ))}
    </section>
  ) : (
    <section class="pb-14">
      <p class="text-slate-600">No posts in this tag yet.</p>
    </section>
  )}
</BaseLayout>
