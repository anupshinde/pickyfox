---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import PostGrid from '../components/PostGrid.astro';
import ShowMoreLink from '../components/ShowMoreLink.astro';
import { SITE } from '../consts';
import { TAG_TITLE_BY_SLUG, type TagSlug } from '../config/tagTaxonomy';

const allPosts = (await getCollection('posts')).sort(
  (a, b) => new Date(b.data.date || 0).getTime() - new Date(a.data.date || 0).getTime()
);

const MAIN_TAGS: TagSlug[] = ['productivity', 'career-work', 'business-entrepreneurship'];
const SECONDARY_TAGS: TagSlug[] = ['health-wellness', 'content-creativity', 'personal-development'];
const LATEST_COUNT = 6;
const MAIN_SECTION_POST_COUNT = 7;
const SECONDARY_SECTION_POST_COUNT = 5;

const formatDate = (value: string | undefined) =>
  new Date(value || '').toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });

// Tracks every post already placed on the homepage to prevent repeat cards.
const usedPostSlugs = new Set<string>();
// Tracks lead picks so the same post is not used as the hero in multiple main sections.
const usedMainLeadSlugs = new Set<string>();

const latestPosts = allPosts.slice(0, LATEST_COUNT);
for (const post of latestPosts) {
  usedPostSlugs.add(post.slug);
}

const postsForTag = (tagSlug: TagSlug) => allPosts.filter((post) => post.data.tags?.includes(tagSlug));

const pickUniquePostsForTag = (tagSlug: TagSlug, count: number) => {
  const selected = [];
  for (const post of postsForTag(tagSlug)) {
    if (selected.length >= count) break;
    if (usedPostSlugs.has(post.slug)) continue;
    selected.push(post);
  }
  for (const post of selected) {
    usedPostSlugs.add(post.slug);
  }
  return selected;
};

const pickMainSectionPosts = (tagSlug: TagSlug, count: number) => {
  const taggedPosts = postsForTag(tagSlug);
  const uniqueTaggedPosts = taggedPosts.filter((post) => !usedPostSlugs.has(post.slug));

  // For main section leads, prioritize a post with a feature image.
  // If needed, allow a duplicate from earlier sections to preserve layout quality.
  const lead =
    uniqueTaggedPosts.find((post) => Boolean(post.data.featureImage) && !usedMainLeadSlugs.has(post.slug)) ||
    taggedPosts.find((post) => Boolean(post.data.featureImage) && !usedMainLeadSlugs.has(post.slug)) ||
    uniqueTaggedPosts[0] ||
    taggedPosts[0];

  if (!lead) return [];

  usedMainLeadSlugs.add(lead.slug);
  usedPostSlugs.add(lead.slug);

  const more = [];
  for (const post of uniqueTaggedPosts) {
    if (more.length >= count - 1) break;
    if (post.slug === lead.slug) continue;
    if (usedPostSlugs.has(post.slug)) continue;
    more.push(post);
    usedPostSlugs.add(post.slug);
  }

  return [lead, ...more];
};

const mainSections = MAIN_TAGS.map((tagSlug) => {
  const posts = pickMainSectionPosts(tagSlug, MAIN_SECTION_POST_COUNT);
  return {
    tagSlug,
    title: TAG_TITLE_BY_SLUG[tagSlug],
    lead: posts[0],
    more: posts.slice(1)
  };
});

const secondarySections = SECONDARY_TAGS.map((tagSlug) => ({
  tagSlug,
  title: TAG_TITLE_BY_SLUG[tagSlug],
  posts: pickUniquePostsForTag(tagSlug, SECONDARY_SECTION_POST_COUNT)
}));
---
<BaseLayout title={SITE.name} description={SITE.description}>
  <section class="flex items-center justify-between gap-4 py-10">
    <h2 class="text-2xl font-extrabold uppercase tracking-tight text-slate-900">Latest</h2>
    <ShowMoreLink
      href="/latest/"
      label="Show more"
      class="text-sm font-semibold text-slate-500 transition hover:text-slate-800"
    />
  </section>
  <PostGrid posts={latestPosts} class="grid gap-6 pb-12 sm:grid-cols-2 lg:grid-cols-3" />

  {mainSections.map((section) => (
    <section class="border-t border-slate-200 py-12">
      <div class="mb-7 flex items-center justify-between gap-4">
        <h2 class="text-2xl font-extrabold uppercase tracking-tight text-slate-900">{section.title}</h2>
        <ShowMoreLink
          href={`/tag/${section.tagSlug}/`}
          label="Show more"
          class="text-sm font-semibold text-slate-500 transition hover:text-slate-800"
        />
      </div>

      {section.lead && (
        <article class="grid gap-6 border-b border-slate-200 pb-8 lg:grid-cols-[1.2fr,1fr]">
          <a class="overflow-hidden rounded-lg bg-slate-100" href={`/${section.lead.slug}/`}>
            {section.lead.data.featureImage ? (
              <img
                class="h-full max-h-[430px] w-full object-cover"
                src={section.lead.data.featureImage}
                alt={section.lead.data.featureImageAlt || section.lead.data.title}
              />
            ) : (
              <div class="flex h-[280px] items-center justify-center text-sm text-slate-400">No image</div>
            )}
          </a>
          <div class="space-y-4">
            <h3 class="text-3xl font-extrabold leading-tight tracking-tight text-slate-900">
              <a class="transition hover:text-slate-700" href={`/${section.lead.slug}/`}>{section.lead.data.title}</a>
            </h3>
            {section.lead.data.excerpt && (
              <p class="text-lg leading-relaxed text-slate-700">{section.lead.data.excerpt}</p>
            )}
            <p class="text-xs uppercase tracking-[0.08em] text-slate-500">
              {SITE.name} • {formatDate(section.lead.data.date)}
            </p>
          </div>
        </article>
      )}

      {section.more.length > 0 && (
        <div class="grid gap-6 pt-8 md:grid-cols-2">
          {section.more.map((post) => (
            <article class="flex items-start gap-4">
              {post.data.featureImage && (
                <a class="h-20 w-32 shrink-0 overflow-hidden rounded-md bg-slate-100" href={`/${post.slug}/`}>
                  <img
                    class="h-full w-full object-cover"
                    src={post.data.featureImage}
                    alt={post.data.featureImageAlt || post.data.title}
                  />
                </a>
              )}
              <div class="space-y-2">
                <h3 class="text-2xl font-semibold leading-tight text-slate-900 sm:text-3xl md:text-2xl">
                  <a class="transition hover:text-slate-700" href={`/${post.slug}/`}>{post.data.title}</a>
                </h3>
                <p class="text-xs uppercase tracking-[0.08em] text-slate-500">
                  {SITE.name} • {formatDate(post.data.date)}
                </p>
              </div>
            </article>
          ))}
        </div>
      )}
    </section>
  ))}

  <section class="border-t border-slate-200 py-12">
    <div class="grid gap-10 lg:grid-cols-3">
      {secondarySections.map((section) => (
        <section>
          <div class="mb-5 flex items-center justify-between border-b border-slate-200 pb-4">
            <h2 class="text-xl font-extrabold tracking-tight text-slate-900">{section.title}</h2>
            <ShowMoreLink
              href={`/tag/${section.tagSlug}/`}
              label="More"
              class="text-sm font-semibold text-slate-400 transition hover:text-slate-700"
            />
          </div>
          <div class="space-y-4">
            {section.posts.map((post) => (
              <h3 class="text-base leading-relaxed text-slate-800 sm:text-lg lg:text-base">
                <a class="transition hover:text-slate-600" href={`/${post.slug}/`}>{post.data.title}</a>
              </h3>
            ))}
          </div>
        </section>
      ))}
    </div>
  </section>
</BaseLayout>
